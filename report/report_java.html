<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Kotlin Benchmarks</title>
    <link rel="stylesheet" href="jquery.dynatable.css"/>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="jquery.dynatable.js"></script>
</head>
<body>
<div class="container">
    <h1>Kotlin Benchmarks</h1>

    <h2>Comparison with Java</h2>

    <p>
        For multicolumn search separate subqueries with semicolon: "IntListBenchmark;manual;1000"
    </p>

    <p>
        Difference is Kotlin score minus Java score. Positive values are regressions, negative are gains.
    </p>
    <p>
        <a href="report.html">Move to comparison with baseline</a>
    </p>
    <table id="benchmarks" class="table table-bordered">
        <thead><tr>
        <th>Benchmark</th>
        <th style="text-align: right">Size</th>

        <th style="display: none">score</th>
        <th style="text-align: right" data-dynatable-column="scoreString" data-dynatable-sorts="score">Average Time</th>
        <th >Unit</th>
        <th style="text-align: right" data-dynatable-column="errorString" data-dynatable-sorts="error">Error</th>

        <th style="display: none">diff</th>
        <th style="text-align: right" data-dynatable-column="diffString" data-dynatable-sorts="diff">Difference</th>
        <th style="text-align: right" data-dynatable-column="diffPercent" data-dynatable-sorts="diff">% Difference</th>
        </tr></thead>
        <tbody>
        </tbody>
    </table>
</div>
<script>
    function sharedStart(array) {
        var A = array.slice(0).sort(),
                word1 = A[0], word2 = A[A.length - 1],
                L = word1.length, i = 0;
        while (i < L && word1.charAt(i) === word2.charAt(i)) i++;
        return word1.substring(0, i);
    }

    function fixed(value) {
        if (typeof value == 'number')
            return Number(value.toFixed(2));
        else if (typeof value == 'string')
            return Number(parseFloat(value).toFixed(2));
        else
            return "N/A"
    }

    function processTable(baseline, data) {

        var baselineMap = {};
        for (var i = 0, len = baseline.length; i < len; i++) {
            //var key = baseline[i].benchmark + baseline[i].params.size;
            baselineMap[baseline[i].benchmark + baseline[i].params.size] = baseline[i]
        }

        var names = [];
        for (i = 0, len = data.length; i < len; i++)
            names.push(data[i].benchmark)
        var commonPrefix = sharedStart(names);

        for (i = 0, len = data.length; i < len; i++) {
            var key = data[i].benchmark + data[i].params.size;
            var score = data[i].primaryMetric.score;


            data[i].benchmark = data[i].benchmark.substring(commonPrefix.length);
            data[i].size = fixed(data[i].params.size);

            data[i].score = fixed(score);
            data[i].unit = data[i].primaryMetric.scoreUnit;
            data[i].scoreString = score.toFixed(2);

            var scoreError = data[i].primaryMetric.scoreError;
            data[i].error = scoreError;
            data[i].errorString = "Â± " + (scoreError/score * 100).toFixed(2) +"%" + " (" + scoreError.toFixed(2) + ")";

            var baselineItem = baselineMap[key];
            if (baselineItem != undefined) {
                var baselineScore = baselineItem.primaryMetric.score ;
                var diff = score - baselineScore;
                data[i].diff = fixed(diff);
                // Significant difference is chosen to be 2% of base score
                // or measurement error, whichever is higher
                var epsilon = 0.02 * baselineScore;
                var limit = scoreError > epsilon ? scoreError : epsilon;
                if (diff < -limit) {
                    data[i].diffString = diff.toFixed(2);
                    data[i].diffPercent = (diff / score * 100).toFixed(2) + "%";
                    data[i].diffString_class = "improvement";
                    data[i].diffPercent_class = "improvement";
                } else if (diff > limit) {
                    data[i].diffString = "+" + diff.toFixed(2);
                    data[i].diffPercent = "+" + (diff / score * 100).toFixed(2) + "%";
                    data[i].diffString_class = "regression";
                    data[i].diffPercent_class = "regression";
                } else {
                    data[i].diffString = "";
                    data[i].diffPercent = "";
                    data[i].diffString_class = "same";
                    data[i].diffPercent_class = "same";
                }
            } else {
                data[i].diff = 0;
                data[i].diffString = "no Java";
                data[i].diffPercent = "";
                data[i].diffString_class = "regression";
                data[i].diffPercent_class = "regression";
            }
        }

        var dynatable = $('#benchmarks').dynatable({
            features: {
                pushState: false,
                paginate: false,
                sort: true,
                recordCount: true

            }, dataset: {
                records: data,
                perPageDefault: 100,
                perPageOptions: [10, 20, 50, 100]
            }
        }).data('dynatable');
        dynatable.sorts.add('benchmark', 1);
        dynatable.sorts.add('size', 1);
        dynatable.records.sort();
        dynatable.dom.update();
    }

    // Should find in data all benchmarks with name of *Java or Java*,
    // remove the Java suffix / prefix, remove these benchmarks from data and return as result
    function extractJava(data) {
        var java = [];
        var javaIndexes = [];
        for (var i = 0, len = data.length; i < len; i++) {
            var name = data[i].benchmark;
            var j = name.indexOf("Java");
            if (j != -1) {
                javaIndexes.push(i);
                name = name.substring(0, j) + name.substring(j+4);
                data[i].benchmark = name;
                java.push(data[i]);
            }
        }
        var k = 0;
        for (i = 0; i-k < data.length; i++) {
            if (k >= javaIndexes.length || i != javaIndexes[k]) {
                // DO NOTHING
            } else {
                data.splice(i - k, 1);
                k++;
            }
        }
        return java;
    }

    $.ajax({
        url: 'benchmarks.json',
        success: function (data) {
            var baseline = extractJava(data);

            processTable(baseline, data);
        }
    });


</script>
</body>
</html>